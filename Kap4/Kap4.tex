% !TeX spellcheck = es_ES
%\chapter{Cap\'{\i}tulo 3}
%\chapter{Solution Proposal}
\chapter{Propuesta de solución}
En esta sección se propone una extensión para los EP que apoya el desarrollo de la representación del dominio de la simulación de procesos EOR. Adicionalmente, se conceptualizan los términos derivados de las ecuaciones presentadas en el marco teórico, a partir de los cuales se generan las relaciones estructurales. Posteriormente, se muestra el EP completo de la simulación y se explican por secciones los conceptos principales o clases y los eventos que ejecutan la simulación.

Esta sección se estructura así: en la sección \ref{sec:PSNew} se presenta el elemento adicional para los EP que permite reutilizar una representación en múltiples secciones del EP y la regla para la obtención de código a partir del nuevo elemento. En la sección \ref{sec:Concepts} se revisan los términos de cada ecuación y su traducción a los conceptos presentes en el EP. En la sección \ref{sec:PS_EOR} se muestra el EP completo y se explican las relaciones dinámicas y eventuales por cada concepto principal.

%In this section we propose one element as an extension for Preconceptual Schemas(PS) which aid the understanding of diverse elements in the oil reservoir simulation domain. In addition, we present further description of the concepts stated in the theoretical framework, with their respective representation in the elaborated PS.
%This section is structured as follows: in section  we present the added elements to PS and their usage in our represented domain. In section  we propose the representation of structural and dynamical behavior of each developed concept in the theoretical framework using PS.

%\section{Added elements to Preconceptual Schemas}\label{sec:PSNew}
%\subsection{Analyst defined subroutines}\label{sec:PS_ADS}
%Analyst defined subroutines are analyst defined functions as proposed by (ref Calle) without the return argument. They use global elements and parameters of the subroutine definition. They are defined for re-using dynamical behavior elements which appear more than once in the PS. Names of both subroutines and functions must differ from operators predefined in the PS. Graphic symbol used for subroutines is the same as used for operators and functions. In figure \# we present graphical representation of analyst defined subroutines.

\section{Extensión al Esquema Preconceptual}\label{sec:PSNew}
\subsection{Subrutinas definidas por el analista}\label{sec:PS_ADS}
Las subrutinas definidas por el analista son funciones definidas tal como \cite{JCalle} propuso, pero carecen de un concepto retorno ``return''. Estas utilizan elementos globales y también pueden recibir parámetros adicionales, su representación gráfica es igual a la de una función, pero en su uso no hay una asignación. En la figura \ref{fig:Subroutine} se presenta la representación gráfica y su traducción a código. %\citep{AG01}.
%Nota: Poner tabla y gráfica de uso

%\section{Conceptualization}\label{sec:Concepts}
\section{Conceptualización}\label{sec:Concepts}
En esta sección se traducen las ecuaciones algebraicas, resultantes de la discretización del modelo Black-Oil extendido y las ecuaciones constitutivas usando el método de los volúmenes finitos, a los conceptos principales y su respectiva categoría. 

%\subsection{Mesh}
\subsection{Malla}
Al resolver el dominio espacial continuo como un conjunto discreto de celdas (discretizar el espacio), aparecen propiedades tales como los volúmenes de las celdas y el área de las caras. Este conjunto discreto de celdas es el que denominamos como ``malla''. A su vez, la celda es vista como un conjunto discreto de caras que generan una superficie cerrada\footnote{En el caso tridimensional}. Cada celda cuenta con una numeración, esta sirve para identificar posiciones en el espacio y ubicar las vecindades correspondientes para el cálculo del flujo discretizado.

Luego: 
%Poner ecuación acá con Volumen de celda ya como concepto

%\subsection{Rock}
\subsection{Roca}


\subsection{Fluido}
%\subsection{Phase}
%
\subsection{Interacción Interfluido}
%\subsection{Inter-phase interaction}
%
%\subsection{Component}
%
%\subsection{Equlibrium Relation}
\subsection{Relación de Equilibrio}
%
%\subsection{Well}
\subsection{Pozo}

%\section{PS Representation of Enhanced Oil Recovery Simulation}\label{sec:PS_EOR}
\section{Representación en EP de la simulación de procesos EOR}\label{sec:PS_EOR}
En esta sección proponemos una representación basada en un EP para procesos EOR de inyección de múltiples químicos. En el esquema \ref{fig:PSComplete} se evidencia la solución del modelo Black Oil discretizado usando volúmenes finitos en una malla cartesiana ortogonal. En el evento ``Presión del fluido varía'' se desarrollan las iteraciones del método de Newton-Raphson e internamente las iteraciones sobre las celdas requeridas para solucionar el sistema algebráico resultante de la discretización. En las secciones siguientes se explica el esquema preconceptual elaborado en las respectivas porciones correspondientes a los conceptos principales en la simulación de procesos EOR.
%In this section we propose a PS representation for enhanced oil recovery simulation, we couple a black oil model discretized using finite volumes method with the theoretical framework developed the previous chapter. We mapped each term in the resultant equations to their respective concepts and how they are linked together. The complete representation is shown in \ref{fig:PSComplete}.\\
\begin{figure}[h]
\centering%
\includegraphics[width=0.9\linewidth]{Kap4/MultifasicoSinPozos.pdf}%
%\caption{Complete PS Representation for EOR Processes} \label{fig:PSComplete}
\caption{Representación en EP de la simulación de procesos EOR} \label{fig:PSComplete}
\end{figure}

%The rest of this section is as follows: In section \ref{sec:PS_Mesh} we present the Mesh concept as a collection of cells with additional elements needed for calculating the attributes of each cell. Furthermore, we develop the dynamical relationship ``Geomodeler defines Mesh'' as an interaction of the role ``Geomodeler'' with atomic\footnote{atomic as is stated by \cite{AG01} (Aca debe ir Zapata)} dynamical relationships. In section \ref{sec:PS_Rock} we present the Rock concept with its attributes and initial characterization. In section \ref{sec:PS_Phase} ... In section \ref{sec:PS_Interphase} ... In section \ref{sec:PS_Equilibrium} we define the partition coefficients as relations between two phases, one contributing mass and another receiving mass in the mass balance equation. In section \ref{sec:PS_Well}  

%\subsection{Mesh}\label{sec:PS_Mesh}
\subsection{Malla}\label{sec:PS_Mesh}

De la conceptualización de los elementos relacionados con la discretización, se encontró que existe una malla la cuál contiene todas las propiedades necesarias para generar el conjunto de celdas. Además, existe un actor ``Geomodelador'' que se encarga de definir el número de celdas en cada eje, sus espesores y topes tal como se presenta en \ref{fig:Mesh}. \\
\begin{figure}[h]
	\centering%
	\includegraphics[width=0.9\linewidth]{Kap4/Mesh.pdf}%
	\caption{Definición de la malla} \label{fig:Mesh}
\end{figure}
Una vez definidas tales propiedades, la malla aparece en un proceso iterativo de creación de la cantidad de celdas definidas y el respectivo cálculo de volúmenes, profundidades y numeración. Posteriormente, las caras se crean en otro proceso iterativo, estas contienen la información sobre las vecindades de cada celda, donde cada celda tiene un conjunto de caras\footnote{Es posible notar que la cara existente entre dos celdas vecinas se crea dos veces, una por cada celda.}. 

%We propose a representation of a mesh as a collection of cells which are represented likewise. collection of faces plus their respective attributes. This representation accounts for orthogonal cartesian meshes. Those are generated using the number of cells in each axis or direction, the thickness and top for each cell. Nevertheless, the thickness is only needed for the number of cells defined in every axis, because we work with regular meshes. Therefore the rest of the cells will have the same thickness.
%The top of the mesh is required for the first XY plane, and needs to be filled with the depths of each cell in that plane, the rest of the cells are calculated using the depth of the first plane.

%The representation stated for Mesh only accounts for orthogonal cartesian meshes, which can be generated with information about number of cells in each axis, their thickness and tops. A (The information above is inserted by a) Geomodeler with defines the mesh by inserting for each axis the number of cells and the thickness for cells in that direction. Once 

%\subsection{Rock}\label{sec:PS_Rock}
\subsection{Roca}\label{sec:PS_Rock}

La especificación de la relación dinámica ``Petrofísico caracteriza roca'' consiste de insertar las condiciones iniciales de porosidad y permeabilidad absoluta para la roca asociada al yacimiento, es posible notar que estos atributos de la roca están representados como arreglos por la cantidad de términos, derivados de los pasos de tiempo (estos se verán más adelante), y la cantidad de celdas definidas en la malla. \\
Adicionalmente, el petrofísico define la compresibilidad de poro y la presión a la que esta se mide para el cálculo de la porosidad a los términos posteriores. El modelo considera la existencia de una única roca a la cual todas las propiedades por cada una de las celdas son asignadas. La caracterización de la roca se presenta en \ref{fig:Rock}.\\

\begin{figure}[h]
	\centering%
	\includegraphics[width=0.90\linewidth]{Kap4/Rock.pdf}%
	\caption{Caracterización de la Roca.} \label{fig:Rock}
\end{figure}

%\subsection{Phase}\label{sec:PS_Phase}
\subsection{Fluido}\label{sec:PS_Phase}

Los fluidos tienen propiedades que son funciones de su presión y saturación, estas a su vez son función del tiempo y del espacio. Por lo que todas las propiedades que se proponen en la conceptualización se representan como arreglos dependientes de la cantidad de términos y de la cantidad de celdas. La representación del fluido, su relación dinámica ``Ingeniero de fluidos caracteriza Fluido'' y su respectiva especificación se presentan en la figura \ref{fig:Fluid}.\\

\begin{figure}[h]
	\centering%
	\includegraphics[width=0.9\linewidth]{Kap4/Fluid.pdf}%
	\caption{Fluid Characterization.} \label{fig:Fluid}
\end{figure}

En pos de la generalidad, definimos la viscosidad del fluido y su factor volumétrico como funciones directas de la presión. Con este fin, aparece el concepto de propiedad medida, el cuál tiene una medida de referencia y un valor medido a esa referencia. Ambos son arreglos de la cantidad de medidas. En la figura \ref{fig:Fluid} también es posible ver que el fluido tiene una viscosidad medida y un factor volumétrico medido. Esto nos permite calcular de manera general estas propiedades del agua, gas y el aceite como una interpolación en el conjunto de medidas a una presión arbitraria. La viscosidad medida y el factor volumétrico medido los inserta el Ingeniero de fluidos al caracterizar el fluido. \\

Es importante notar también que el fluido tiene un tipo y un atributo de tipo lógico ``Principal''. El tipo del fluido nos permite explicitar que este es Petróleo, Gas o Agua, pero el atributo de principalidad indica que es el fluido para el cuál la incógnita a resolver será la presión, en los demás la incógnita será la saturación.

%\subsection{Equilibrium Relation}\label{sec:PS_Equilibrium}
\subsection{Relación de Equilibrio.}\label{sec:PS_Equilibrium}
Las ecuaciones del Black Oil relacionan la posible existencia de masa de gas en el aceite (Rs o gas disuelto), y, en el caso del Black Oil extendido, la de aceite en el gas (Rv o aceite volatilizado). En el concepto ``Relación de equilibrio'', se generaliza la existencia de masa de un fluido dentro de otro fluido como un coeficiente de partición, tal como se vio en la conceptualización (ver \ref{sec:Concepts}). Se asume, también, que existe un fluido que aporta masa y otro que la recibe, tal como se ve en \ref{fig:EqRelation}. El coeficiente de partición cumple la mismas condiciones de la viscosidad del fluido y a su vez, tiene un coeficiente de partición medido. 

\begin{figure}[h]
	\centering%
	\includegraphics[width=0.9\linewidth]{Kap4/Equilibrium.pdf}%
	\caption{Adición de Relaciones de equilibrio.} \label{fig:EqRelation}
\end{figure}

%\subsection{Inter-phase interaction}\label{sec:PS_Interphase}
\subsection{Interacción Interfluido}\label{sec:PS_Interphase}

%\subsection{Component}\label{sec:PS_Component} % This could be changed to Chemical
%\subsection{Well}\label{sec:PS_Well}
\subsection{Pozo}\label{sec:PS_Well}

%includefigure{Graphical Representation of subroutine}

%includegraphic{Code Translation}

%Se deben incluir tantos cap\'{\i}tulos como se requieran; sin embargo, se recomienda que la tesis  o trabajo de investigaci\'{o}n tenga un m\'{\i}nimo 3 cap\'{\i}tulos y m\'{a}ximo de 6 cap\'{\i}tulos (incluyendo las conclusiones).\\